{% extends "base.html" %}
{% block content %}
<div class="container py-4">

  <!-- Search & Filter -->
  <form method="get" action="{% url 'store:index' %}" class="row mb-4 g-2 align-items-center">
    <div class="col-md-6">
      <input type="text" name="q" class="form-control"
             placeholder="Search products..."
             value="{{ request.GET.q|default:'' }}">
    </div>
    <div class="col-md-4">
      <select name="category" class="form-select">
        <option value="">All Categories</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>
            {{ cat.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" type="submit">Filter</button>
    </div>
  </form>

  {% if query %}
    <h4 class="mb-4">Search results for: <span class="text-primary">"{{ query }}"</span></h4>
  {% endif %}

  {% if products %}
    <div class="row">
      {% for product in products %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm">
          {% if product.featured_image %}
            <img src="{{ product.featured_image.url }}" 
                 class="card-img-top" 
                 alt="{{ product.title }}"
                 loading="lazy"
                 onerror="this.src='https://via.placeholder.com/400x300?text=No+Image';">
          {% else %}
            <img src="https://via.placeholder.com/400x300?text=No+Image"
                 class="card-img-top"
                 alt="No image available"
                 loading="lazy">
          {% endif %}

          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ product.title }}</h5>
            {% if product.price %}
              <p class="card-text text-muted">KSh {{ product.price }}</p>
            {% endif %}
            <button class="btn btn-primary mt-auto view-product-btn"
                    data-product-id="{{ product.id }}"
                    data-bs-toggle="modal"
                    data-bs-target="#productModal">
              View Details
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning text-center">
      No products found{% if query %} for "<strong>{{ query }}</strong>"{% endif %}.
    </div>
  {% endif %}
</div>

<!-- Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        
        <!-- Main Image with Navigation -->
        <div class="position-relative">
          <img id="mainProductImage" class="img-fluid" alt="Product image">
          <button id="prevImage" class="btn btn-light position-absolute top-50 start-0 translate-middle-y">
            &#10094;
          </button>
          <button id="nextImage" class="btn btn-light position-absolute top-50 end-0 translate-middle-y">
            &#10095;
          </button>
        </div>

        <!-- Thumbnails -->
        <div class="d-flex justify-content-center mt-3 flex-wrap" id="thumbnailContainer"></div>

        <!-- Product Details -->
        <p id="productDescription" class="mt-3"></p>
        <p id="productPrice" class="fw-bold"></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const modalLabel = document.getElementById('productModalLabel');
  const mainImage = document.getElementById('mainProductImage');
  const productDescription = document.getElementById('productDescription');
  const productPrice = document.getElementById('productPrice');
  const thumbnailContainer = document.getElementById('thumbnailContainer');
  const prevBtn = document.getElementById('prevImage');
  const nextBtn = document.getElementById('nextImage');

  let images = [];
  let currentIndex = 0;

  function updateMainImage(index) {
    if (images.length > 0) {
      currentIndex = index;
      mainImage.src = images[index];
      document.querySelectorAll('#thumbnailContainer img').forEach((thumb, idx) => {
        thumb.classList.toggle('border-primary', idx === index);
        thumb.classList.toggle('border', true);
      });
    }
  }

  prevBtn.addEventListener('click', () => {
    if (images.length) {
      updateMainImage((currentIndex - 1 + images.length) % images.length);
    }
  });

  nextBtn.addEventListener('click', () => {
    if (images.length) {
      updateMainImage((currentIndex + 1) % images.length);
    }
  });

  document.querySelectorAll('.view-product-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.productId;
      try {
        const res = await fetch(`/api/product/${id}/`);
        if (!res.ok) throw new Error('Network error');
        const data = await res.json();

        modalLabel.textContent = data.title;
        productDescription.textContent = data.description || '';
        productPrice.textContent = data.price ? `KSh ${data.price}` : '';

        images = data.all_images || [];


        // Load thumbnails
        thumbnailContainer.innerHTML = '';
        images.forEach((src, idx) => {
          const thumb = document.createElement('img');
          thumb.src = src;
          thumb.className = 'img-thumbnail m-1';
          thumb.style.width = '80px';
          thumb.style.cursor = 'pointer';
          thumb.addEventListener('click', () => updateMainImage(idx));
          thumbnailContainer.appendChild(thumb);
        });

        updateMainImage(0);

      } catch (err) {
        modalLabel.textContent = 'Error';
        productDescription.textContent = 'Could not load product details.';
        productPrice.textContent = '';
        mainImage.src = '';
        thumbnailContainer.innerHTML = '';
        console.error(err);
      }
    });
  });
});
</script>
{% endblock %}
